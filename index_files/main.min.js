var id;
var content;
var resultFind;

$(function(){

    $('.nav-bar > a.has-childs', '.left-nav').click(function() {
        
        if ( !$(this).hasClass('opened') ) {
            $(this).addClass('opened');
            $(this).next().removeClass('hidden');
            return false;
        }
    });

    $('#modal-window-order-product').on('click', '#send-order-button', function() {
        var $form = $(this).closest('form');
        var $accept = $("#accept", $form);
        var $accept2 = $("#accept2", $form);
        if ( !$accept.prop("checked")) {
            alert("Необходимо дать согласие на обработку персональных данных");
            return false;
        }
        if ( !$accept2.prop("checked")) {
            alert("Необходимо указать то, что вы прочли пользоватльское соглашение");
            return false;
        }

        
    });


    /* эмуляция ссылки */
    $(document).on('click', '.link-emulator, .link-emulator-menu, .link-emulator-menu-footer', function () {
        window.location.href = $(this).data('href')
    });

    /*common.js part 1*/

    $(".about-company-brief .learn-more").click(function() {
        $('html, body').animate({
            scrollTop: $("main").offset().top
        }, 500);
    });

    lightbox.option({
        "resizeDuration": 200,
        "wrapAround": true,
        "albumLabel":	"Изображение %1 / %2"
    });

    /*$(".menu-but").click(function() {
        $(".main-navigation").slideToggle();
    });*/

    /* запуск слайдера фильтра */
    if ($(".filter-slider").length) {

        var max_cargo_transport_start = $("#max_cargo_transport_start").val();       // грузоподъемность в тоннах (начальное значение)
        var max_cargo_transport_stop  = $("#max_cargo_transport_stop").val();       // грузоподъемность в тоннах (конечное значение)
        var max_platform_width_start  = $("#max_platform_width_start").val();      // ширина площадки в миллиметрах (начальное значение)
        var max_platform_width_stop   = $("#max_platform_width_stop").val();      // ширина площадки в миллиметрах (конечное значение)
        var max_platform_length_start = $("#max_platform_length_start").val();   // длина площадки в миллиметрах (начальное значение)
        var max_platform_length_stop  = $("#max_platform_length_stop").val();   // длина площадки в миллиметрах (конечное значение)
        var max_platform_height_start = $("#max_platform_height_start").val(); // погрузочная высота в миллиметрах (начальное значение)
        var max_platform_height_stop  = $("#max_platform_height_stop").val(); // погрузочная высота в миллиметрах (конечное значение)

        /* грузоподъёмность слайдер */
        $("#max-cargo").slider({
            min: +max_cargo_transport_start,
            max: max_cargo_transport_stop,
            values: [max_cargo_transport_start, max_cargo_transport_stop],
            range: true,
            slide: function(event, ui) {
                var $activeSlider = $(event.target);
                $activeSlider.parents(".filter-item").find(".val-min").val(ui.values[0]);
                $activeSlider.parents(".filter-item").find(".val-max").val(ui.values[1]);
            }
        });

        /* ширина площадки */
        $("#max_platform_width").slider({
            min: +max_platform_width_start,
            max: max_platform_width_stop,
            values: [max_platform_width_start, max_platform_width_stop],
            range: true,
            slide: function(event, ui) {
                var $activeSlider = $(event.target);
                $activeSlider.parents(".filter-item").find(".val-min").val(ui.values[0]);
                $activeSlider.parents(".filter-item").find(".val-max").val(ui.values[1]);
            }
        });

        /* длина площадки */
        $("#max_platform_length").slider({
            min: +max_platform_length_start,
            max: max_platform_length_stop,
            values: [max_platform_length_start, max_platform_length_stop],
            range: true,
            slide: function(event, ui) {
                var $activeSlider = $(event.target);
                $activeSlider.parents(".filter-item").find(".val-min").val(ui.values[0]);
                $activeSlider.parents(".filter-item").find(".val-max").val(ui.values[1]);
            }
        });

        /* погрузочная высота */
        $("#max_platform_height").slider({
            min: +max_platform_height_start,
            max: max_platform_height_stop,
            values: [max_platform_height_start, max_platform_height_stop],
            range: true,
            slide: function(event, ui) {
                var $activeSlider = $(event.target);
                $activeSlider.parents(".filter-item").find(".val-min").val(ui.values[0]);
                $activeSlider.parents(".filter-item").find(".val-max").val(ui.values[1]);
            }
        });

    }

    $(".filter-slider").each(function() {

        var $sliderItem = $(this);

        var sliderItemMinVal = $sliderItem.slider( "option", "min" );
        var sliderItemMaxVal = $sliderItem.slider( "option", "max" );

        $sliderItem.after("<div class=\"slider-range-vals clearfix\">"+
            "<span>" + sliderItemMinVal + "</span>"+
            "<span>" + sliderItemMaxVal + "</span>"+
            "</div>");
    });

    $(".filter-item .val-min").change(function(event) {
        var $activeInput = $(event.target);
        var $activeMinInput = $activeInput;
        var $activeMaxInput = $activeInput.siblings(".val-max");

        var valMin = +$activeMinInput.val();
        var valMax = +$activeMaxInput.val();

        var $activeSlider = $activeInput.parents(".filter-item").find(".filter-slider");
        var sliderMaxVal = $activeSlider.slider( "option", "max" );

        if (valMin > sliderMaxVal) {
            valMin = sliderMaxVal;
            $activeMinInput.val(valMin);
        }

        if (valMin > valMax) {
            valMax = valMin;
            $activeMaxInput.val(valMax);
            $activeSlider.slider("values", 1, valMax);
        }

        $activeSlider.slider("values", 0, valMin);

    });

    $(".filter-item .val-max").change(function(event) {
        var $activeInput = $(event.target);
        var $activeMaxInput = $activeInput;
        var $activeMinInput = $activeInput.siblings(".val-min");

        var valMin = +$activeMinInput.val();
        var valMax = +$activeMaxInput.val();

        var $activeSlider = $activeInput.parents(".filter-item").find(".filter-slider");
        var sliderMaxVal = $activeSlider.slider( "option", "max" );

        if (valMax < valMin) {
            valMin = valMax;
            $activeMinInput.val(valMin);
            $activeSlider.slider("values", 0, valMin);
        }

        if (valMax > sliderMaxVal) {
            valMax = sliderMaxVal;
            $activeMaxInput.val(valMax);
        }

        $activeSlider.slider("values", 1, valMax);

    });

    /* allow only digits in val inputs */
    $(".filter-item .val-min, .filter-item .val-max").keypress(function(event) {
        var key, keyChar;
        if(!event) var event = window.event;

        if (event.keyCode) key = event.keyCode;
        else if(event.which) key = event.which;

        if(key==null || key==0 || key==8 || key==13 || key==9 || key==46 || key==37 || key==39 ) return true;
        keyChar=String.fromCharCode(key);

        if(!/\d/.test(keyChar))	return false;
    });

    $(".product-list-item-more").click(function() {
        var $activeProductProperties = $(this).closest('.product-list-item').find(".product-properties-small-screens");

        $(".product-properties-small-screens").not($activeProductProperties).hide();
        $(".product-list-item").removeClass("focused-item");
        $(".product-list-item").removeClass("non-focused-item");

        if ($activeProductProperties.is(":visible")) {
            $activeProductProperties.hide();
        } else {
            $activeProductProperties.show();
            $(this).closest('.product-list-item').addClass("focused-item");
            $(this).closest('.product-list-item').siblings().not(".product-list-head").addClass("non-focused-item");
        }
    });

    $(".about-slider").slick({
        arrows: false,
        dots: true,
        autoplay: true,
        autoplaySpeed: 4000
    });

    var $briefProductsIntro = $(".brief-products-intro");
    var $newsWrap = $(".news-wrap");
    var $headerSlider = $(".header-slider");

    if ($briefProductsIntro.length || $newsWrap.length || $headerSlider.length) {

        $(window).on("resize", function() {
            var win = $(this);
            initBriefProductSlider( win.outerWidth() );
            initNewsSlider( win.outerWidth() );
            initHeaderSlider( win.outerWidth() );
        });

        initBriefProductSlider( $(window).outerWidth() );
        initNewsSlider( $(window).outerWidth() );
        initHeaderSlider( $(window).outerWidth() );

        function initBriefProductSlider(windowWidth) {
            if ( windowWidth < 768 ) {
                if ($(".brief-products-intro").length && !$(".brief-products-intro")[0].slick || $(".brief-products-intro")[0].slick.unslicked) {
                    $(".product-info:nth-child(even)").each(function() {
                        $(this).children(".brief-product-text").swapWith( $(this).children(".brief-product-image") );
                    });
                    $(".brief-products-intro").slick({
                        arrows: false,
                        dots: true,
                        adaptiveHeight: true
                    });
                }
            } else {
                if ($(".brief-products-intro").length && $(".brief-products-intro")[0].slick && !$(".brief-products-intro")[0].slick.unslicked) {
                    $(".brief-products-intro").slick("unslick");
                    $(".product-info:nth-child(even)").each(function() {
                        $(this).children(".brief-product-text").swapWith( $(this).children(".brief-product-image") );
                    })
                }
            }
        }
        function initNewsSlider(windowWidth) {
            if ( windowWidth < 768 ) {
                if (!$(".news-wrap")[0].slick || $(".news-wrap")[0].slick.unslicked) {
                    $(".news-wrap").slick({
                        arrows: false,
                        dots: true,
                        adaptiveHeight: true
                    });
                }
            } else {
                if ($(".news-wrap")[0].slick && !$(".news-wrap")[0].slick.unslicked) {
                    $(".news-wrap").slick("unslick");
                }
            }
        }
        function initHeaderSlider(windowWidth) {console.log(typeof $(".header-slider")[0]);
            if (typeof $(".header-slider")[0] == 'undefined') return;
            if ( windowWidth > 768 ) {
                if ($(".header-slider").length && typeof $(".header-slider")[0] != 'undefined' && $(".header-slider")[0].hasOwnProperty('slick') && !$(".header-slider")[0].slick || $(".header-slider")[0].slick.unslicked) {
                    $(".header-slider").slick({
                        arrows: false,
                        autoplay: true,
                        autoplaySpeed: 5000
                    });
                }
            } else {
                if ($(".header-slider").length && typeof $(".header-slider")[0] != 'undefined' && $(".header-slider")[0].hasOwnProperty('slick') && $(".header-slider")[0].slick && !$(".header-slider")[0].slick.unslicked) {
                    $(".header-slider").slick("unslick");
                }
            }
        }
    }

    $(".product-model-slider").slick({
        slidesToShow: 4,
        draggable: false,
        prevArrow: "<button type=\"button\" class=\"slick-prev\"><i class=\"fa fa-angle-left\" aria-hidden=\"true\"></i></button>",
        nextArrow: "<button type=\"button\" class=\"slick-next\"><i class=\"fa fa-angle-right\" aria-hidden=\"true\"></i></button>",
        responsive: [
            {
                breakpoint: 1050,
                settings : {
                    slidesToShow: 4
                }
            },
            {
                breakpoint: 767,
                settings : {
                    slidesToShow: 1
                }
            }
        ]
    });

    $(".product-type-slider").slick({
        slidesToShow: 5,
        draggable: false,
        prevArrow: "<button type=\"button\" class=\"slick-prev\"><i class=\"fa fa-angle-left\" aria-hidden=\"true\"></i></button>",
        nextArrow: "<button type=\"button\" class=\"slick-next\"><i class=\"fa fa-angle-right\" aria-hidden=\"true\"></i></button>",
        responsive: [
            {
                breakpoint: 1050,
                settings : {
                    slidesToShow: 4
                }
            }
        ]
    });

    $(".product-secondary-images-wrap").slick({
        infinite: false,
        slidesToShow: 2,
        prevArrow: '<button type="button" class="slick-prev"><i class="fa fa-angle-left" aria-hidden="true"></i></button>',
        nextArrow: '<button type="button" class="slick-next"><i class="fa fa-angle-right" aria-hidden="true"></i></button>'
    });

    $(".product-type-image").click(function() {

        $(".product-type-image").removeClass("active");

        var $activeSlide = $(this);
        var imageURL = $activeSlide.data("bg-big-image");
        var $bigSlide = $(".product-slide-big-image");

        $bigSlide.animate({
            "opacity" : 0
        }, 300, function() {
            $bigSlide.css({
                "background-image" : "url(\"" + imageURL + "\")"
            });
            $bigSlide.animate({
                "opacity" : 1
            }, 300);
        });

        $activeSlide.addClass("active");
    });

    /* drop buttons */
    var $orderCallBut = $(".order-call");
    var $orderCallWindow = $(".order-call-window");

    $(document).mouseup(function(event) {

        var clickInsideOrderCallBut = false;
        var clickInsideOrderCallWindow = false;

        if ($orderCallBut.is(event.target) || $orderCallBut.has(event.target).length != 0) {
            clickInsideOrderCallBut = true;
        } else if ($orderCallWindow.is(event.target) || $orderCallWindow.has(event.target).length != 0) {
            clickInsideOrderCallWindow = true;
        }

        if (clickInsideOrderCallBut) {
            if ($orderCallWindow.is(':visible')) {
                $orderCallWindow.removeAttr("style");
            } else {
                $orderCallWindow.show();
            }
            return;
        }

        if (clickInsideOrderCallWindow) {
            return;
        }

        if ($orderCallBut.is(':visible')) $orderCallWindow.removeAttr("style");

    });
    /* end dropbuttons */
    /*end common.js part 1*/


    /*=== Отмена перехода по ссылке в окне заказа обратного звонка ===*/
    $(".order-call").on('click', function(e){
        e.preventDefault();
    });

    /*=== Фильтрация товаров выбранной категории ===*/
    // применение фильтра
    $("#filtr_add").on('click', function(e){

        e.preventDefault();

        // получаем значения выбранного фильтра
        var max_cargo_transport_start = $("#max_cargo_transport_start").val();       // грузоподъемность в тоннах (начальное значение)
        var max_cargo_transport_stop  = $("#max_cargo_transport_stop").val();       // грузоподъемность в тоннах (конечное значение)
        var max_platform_width_start  = $("#max_platform_width_start").val();      // ширина площадки в миллиметрах (начальное значение)
        var max_platform_width_stop   = $("#max_platform_width_stop").val();      // ширина площадки в миллиметрах (конечное значение)
        var max_platform_length_start = $("#max_platform_length_start").val();   // длина площадки в миллиметрах (начальное значение)
        var max_platform_length_stop  = $("#max_platform_length_stop").val();   // длина площадки в миллиметрах (конечное значение)
        var max_platform_height_start = $("#max_platform_height_start").val(); // погрузочная высота в миллиметрах (начальное значение)
        var max_platform_height_stop  = $("#max_platform_height_stop").val(); // погрузочная высота в миллиметрах (конечное значение)

        /* отправка запроса на сервер */
        $.ajax({
            url: '/category/filtr-products',
            type: "GET",
            data: {
                "max_cargo_transport_start": max_cargo_transport_start,
                "max_cargo_transport_stop": max_cargo_transport_stop,
                "max_platform_width_start": max_platform_width_start,
                "max_platform_width_stop": max_platform_width_stop,
                "max_platform_length_start": max_platform_length_start,
                "max_platform_length_stop": max_platform_length_stop,
                "max_platform_height_start": max_platform_height_start,
                "max_platform_height_stop": max_platform_height_stop
            },
            success: function(result){

                if(!result) alert("Ошибка приминения фильтра!");

              /*  content = result.split("%%"); */
                content = result;

                /* обновляем данные страницы */
                $(".product-list").html(content);

                num = $(".product-list-item").length

                console.log(num)

                /* обновление информации о количестве найденных товаров в категории */
                resultFind = "Найдено " + declOfNum(num, ['вариант', 'варианта', 'вариантов']);

                $(".product-list-number p").html(resultFind);


            },
            error: function(){
                alert("Ошибка приминения фильтра!");
            }

        });

    });


    /*=== Заказ обратного звонка с сайта ===*/
    /*    $(".call_me-pleas").on('click', function(){

     // поле Имя
     var nome = $(this).parent().parent().find("input[name='nome']").val();

     // поле номер телефона
     var telefono = $(this).parent().parent().find("input[name='telefono']").val();

     // если данные НЕ пустые
     if(nome && telefono){
     // отправка запроса на сервер
     $.ajax({
     url: '/contacts/call-me-pleas',
     type: "POST",
     data: { "nome": nome, "telefono": telefono },
     success: function(result){

     if(!result) alert("Ошибка отправки!");

     alert("Заявка успешна принята!\nВ ближайшее время наш менеджер свяжется с Вами.");
     document.location.href = window.location;
     },
     error: function(){
     alert("Ошибка отправки!");
     }

     });
     }

     });*/


    /*=== Форма заказа выбранной продукции (низкорамные и высокорамные прицепы, прицепы) - всплывающее окно ===*/
    $(".product-list").on('click', '.button-purchase-product', function(e){

        e.preventDefault();

        /* если товар есть в наличии */
        /* if( !$(this).hasClass('button-disabled') ) { */
            /* удаление класса у блока модального окна (если класс присутствует) */
            if($(".modal-lg").hasClass("order-production-width")) {
                $(".modal-lg").removeClass("order-production-width");
            }

            /* добавление класса блоку модального окна */
            $(".modal-lg").addClass("order-product-width");

            /* id выбранного продукта */
            id = $(this).children().data('product');

            /* если есть данные */
            if(id){
                /* отправка запроса на сервер */
                $.ajax({
                    url: '/contacts/order-show',
                    type: "GET",
                    data: { "id": id},
                    success: function(result){
                        if(!result) alert("Ошибка!");

                        showModal(result);
                    },
                    error: function(){
                        alert("Ошибка!");
                    }
                });
            }
        /* } */

    });

    $(".related-products__item").on('click', '.button-purchase-product', function(e){

        e.preventDefault();

        /* если товар есть в наличии */
        /* if( !$(this).hasClass('button-disabled') ) { */
        /* удаление класса у блока модального окна (если класс присутствует) */
        if($(".modal-lg").hasClass("order-production-width")) {
            $(".modal-lg").removeClass("order-production-width");
        }

        /* добавление класса блоку модального окна */
        $(".modal-lg").addClass("order-product-width");

        /* id выбранного продукта */
        id = $(this).children().data('product');

        /* если есть данные */
        if(id){
            /* отправка запроса на сервер */
            $.ajax({
                url: '/contacts/order-show',
                type: "GET",
                data: { "id": id},
                success: function(result){
                    if(!result) alert("Ошибка!");

                    showModal(result);
                },
                error: function(){
                    alert("Ошибка!");
                }
            });
        }
        /* } */

    });

    /*=== Форма заказа продукции под заказ(низкорамные и высокорамные прицепы, прицепы) - всплывающее окно ===*/
    $(".nothing-found-q").on('click', 'a', function(e){

        e.preventDefault();

        /* удаление класса у блока модального окна (если класс присутствует) */
        if($(".modal-lg").hasClass("order-product-width")) {
            $(".modal-lg").removeClass("order-product-width");
        }

        /* добавление класса блоку модального окна */
        $(".modal-lg").addClass("order-production-width");

        /* отправка запроса на сервер */
        $.ajax({
            url: '/contacts/zakaz-show',
            type: "GET",
            success: function(result){
                if(!result) alert("Ошибка!");

                showModal(result);
            },
            error: function(){
                alert("Ошибка!");
            }
        });

    });
});

/* склонение числа */
function declOfNum(number, titles){
    var cases = [2, 0, 1, 1, 1, 2];
    return number + " " + titles[ (number % 100 > 4 && number % 100 < 20) ? 2 : cases[Math.min(number % 10, 5)] ];
}

/* показ модальных окон */
function showModal(result){
    $("#modal-window-order-product .modal-body").html(result);
    $("#modal-window-order-product").modal();
}


/*start common.js part 1*/

jQuery.fn.swapWith = function(to) {
    return this.each(function() {
        var copy_to = $(to).clone(true);
        var copy_from = $(this).clone(true);
        $(to).replaceWith(copy_from);
        $(this).replaceWith(copy_to);
    });
};

/* Returns a function, that, as long as it continues to be invoked, will not
 be triggered. The function will be called after it stops being called for
 N milliseconds. If `immediate` is passed, trigger the function on the
 leading edge, instead of the trailing. */
function debounce(func, wait, immediate) {
    var timeout;
    return function() {
        var context = this, args = arguments;
        var later = function() {
            timeout = null;
            if (!immediate) func.apply(context, args);
        };
        var callNow = immediate && !timeout;
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
        if (callNow) func.apply(context, args);
    };
}
/*end common.js part 2*/